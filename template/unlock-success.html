<!DOCTYPE HTML>
<html>
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,minimal-ui" />
    <meta charset="utf-8" />
    <title>12132</title>
    <meta name="x5-fullscreen" content="true">
    <meta name="full-screen" content="yes">
    <meta http-equiv="pragma" content="no-cache">
    <link href="../lib/light7/css/light7.min.css" rel="stylesheet"/>
    <link href="../lib/fontAw/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="../dist/css/all.css" rel="stylesheet"/>
  </head>
  <body>
    <div class="page">
      <!-- 头部菜单 start -->
      <header class="bar bar-nav">
        <div class="button button-link button-nav pull-left">
          <!-- <span class="tips-arrow">MAT</span> -->
        </div>
        <h1 class="title">
        <div class="calendar-header">
          <i class="fa fa-calendar">
          </i>
          <input class="date-input" id="my-input" type="button"/>
        </div>
        </h1>
      </header>
      <!-- 头部菜单 end -->
      <!-- 二级菜单 start -->
      <div class="bar bar-header-secondary">
        <div class="optional-header row no-gutter table-row-header no-edit">
          <div class="col-4-tym">
            产品
          </div>
          <div class="col-4-scfe">
            <div class="col-child-2" onclick="scfeAction(this)">
              <span class="break">
                市场份额
              </span>
              <span class="tips-arrow">
                MTH
              </span>
              <span class="tips-arrow hidden">
                YTD
              </span>
              <span class="tips-arrow hidden">
                MAT
              </span>
            </div>
          </div>
          <div class="col-4-zdf sort" data-sortname="change">
            涨跌幅
          </div>
          <div class="col-4-ev sort" data-sortname="ev">
            EV
          </div>
        </div>
      </div>
      <!-- 二级菜单 end -->
      <div class="content has-secondary-bar has-footer-secondary no-footer infinite-scroll" data-distance="100">
        <div class="center">
          <div class="list-block item-pean-horizontal">
            <ul class="table-row" id="getHosProductInfo">
            </ul>
            <div class="userProvide">
              该医院数据由
              <span id="userProvideData">
              </span>
              合作用户提供
            </div>
            <div class="unlock-button">
              <button class="button button-fill button-big" onclick="unlockSelfAction(this)">
              <i class="fa fa-unlock fa-fw">
              </i>
              解锁
              </button>
              <p class="tips">
                小提示:「解锁」后可查看全部数据
              </p>
            </div>
          </div>
          <!-- 下拉无限滚动 -->
          <div class="infinite-scroll-preloader">
            <div class="preloader">
            </div>
          </div>
        </div>
      </div>
      <div class="bar bar-footer-secondary bar-footer-secondary-nofooter text-center">
        <div class="text">
          可解锁医院
          <span id="allHospital">
          </span>
          ，已解锁医院
          <span id="readyHospital">
          </span>
        </div>
      </div>
    </div>
    <!-- <script src="dist/js/jquery.min.js"></script> -->
    <script src="../src/js/jweixin-1.0.0.js" type="text/javascript">
    </script>
    <script src="http://light7.org/assets/js/zepto.js"></script>
    <script src="../lib/light7/js/light7.js">
    </script>
    <script charset="utf-8" src="../lib/light7/js/light7-city-picker.min.js" type="text/javascript">
    </script>
    <script src="../src/js/data.api.js" type="text/javascript">
    </script>
    <script src="../src/js/all.js">
    </script>
    <script type="text/javascript">
    document.title = '医院编码:'+decode(url2obj(location.search).title);
    // 判断是否需要显示解锁按钮
    function lockStateInfo(){
      dataApi.getLockStateInfo(function(res){
        if(res.count != 0 || url2obj(location.search).type == 0){
        $('.unlock-button').remove();
        }
      });
    }
    lockStateInfo();
    var loading = false;
    $.attachInfiniteScroll('.infinite-scroll');
    $(document).on('infinite', '.infinite-scroll',function() {
    
    dataApi.getHosProductInfo(function(data,total){
    renderDom(data,total);
    },{
    sidx:$('.table-row-header').data('sidx'),
    sord:$('.table-row-header').data('sord')
    });
    });
    $('.infinite-scroll').trigger('infinite');
    $(document).on('click','.sort',function(event){
      $.attachInfiniteScroll('.infinite-scroll');
      $('#getHosProductInfo li').remove();
      sortFn(event.target);
      $('.infinite-scroll').trigger('infinite');
    });
    //读取医院数量
    dataApi.getUserLockInfo(function(d){
    $('#allHospital').text(d.lockCount);
    $('#readyHospital').text(d.userLockCount);
    });
    function unlockSelfAction(obj) {
      var $this = $(obj);
      var num = $('#allHospital').text();
      
        if(num != 0){
          $.confirm('您当前可解锁医院数为' + num + '个，是否'+(num !=0 ? '解锁' : '开通服务')+'?', '提示', function() {
            dataApi.insertUserBreedHosLockInfo(($this.parents('li').data('id') || url2obj(location.search).id), function() {
              $.attachInfiniteScroll('.infinite-scroll');
              $(document).on('infinite', '.infinite-scroll',function() {
                dataApi.getHosProductInfo(function(data,total){
                  $('#getHosProductInfo li').remove();
                  $('.unlock-button').remove();
                  renderDom(data,total);
                },{
                sidx:$('.table-row-header').data('sidx'),
                sord:$('.table-row-header').data('sord')
                });
              });
              $('.infinite-scroll').trigger('infinite');
              //读取医院数量
              dataApi.getUserLockInfo(function(d){
                $('#allHospital').text(d.lockCount);
                $('#readyHospital').text(d.userLockCount);
              });
            });
          },function(){});
        }else{
          location.href="contact.html";
        }
    }
    // 获取合作用户数据
    function getUserProvide(){
    dataApi.getProductPartnerInfo(function(res){
    console.log(res);
    $('#userProvideData').html(res.userName);
    });
    }
    getUserProvide();
    
    function renderDom(data,total){
    var str = '';
    console.log(data);
    if(data.length == 0 ){
    $('.center').hide(0);
    }else{
    $('.center').show(0);
    }
    if (loading) return;
    loading = true;
    $.each(data, function() {
    str += '<li class="item-content no-edit"><div class="item-inner">';
      str += '<div class="col-4-tym"><span class="break">'+this.drugName+' '+this.spec+'*'+this.pack+'</span><span class="jc">'+(this.brandName || this.manufactorShort)+'</span>'
      if(this.singleBase){
      str += '<i class="bradge">基</i>';
      }
      if(this.healthcare){
      str += '<i class="bradge">保</i>'
      }
    str += '</div>';
    str += '<div class="col-4-scfe">';
      str += '<span>'+this.marketMth+'%</span>';
      str += '<span class="hidden">'+this.marketYtd+'%</span>';
      str += '<span class="hidden">'+this.marketMat+'%</span>';
    str += '</div>';
    if(this.change){
        if (this.change >= 0) {
            str += '<div class="col-4-zdf z">' + this.change + '%</div>';
        } else {
            str += '<div class="col-4-zdf d"> ' + this.change + '%</div>';
        }
    }else{
        str += '<div class="col-4-zdf"> ' + this.change + '</div>';
    }
    if(this.ev >= 100){
      str += '<div class="col-4-ev z">'+this.ev+'</div>';
    }else{
      str += '<div class="col-4-ev d">'+this.ev+'</div>';
    }
  str += '</div></li>';
  });
  $(str).appendTo($('#getHosProductInfo'));
  loading = false;
  if($('#getHosProductInfo li').length >= total){
  $.detachInfiniteScroll($('.infinite-scroll'));
  $('.infinite-scroll-preloader').hide();
  }
  }
  </script>
</body>
</html>